name: test-action

env:
  DOCKER_REPO: "unfor19/hero-action"
  HERO_ACTION: "status-update"

on:
  workflow_dispatch:
    inputs:
      src_repository:
        description: Source Repository - {owner}/{repo_name}
        required: true
      src_workflow_name:
        description: Source Workflow Name
        required: true
      src_sha:
        description: Source Repository SHA - GITHUB_SHA
        required: true

jobs:
  test:
    runs-on: ubuntu-20.04
    name: Dummy Test
    steps:
      - uses: actions/checkout@v2
    outputs:
      target_job_status: ${{ job.status }}

  update-status-check:
    name: Update Status Check In Source Repository
    runs-on: ubuntu-20.04
    needs:
      - test
    if: ${{ always() }}
    env:
      HERO_SRC_REPOSITORY: ${{ github.event.inputs.src_repository }}
      HERO_SRC_WORKFLOW_NAME: ${{ github.event.inputs.src_workflow_name }}
      HERO_SRC_SHA: ${{ github.event.inputs.src_sha }}
      HERO_TARGET_JOB_STATUS: ${{ needs.test.outputs.target_job_status }}
    steps:
      - name: Set Environment Variables
        run: |
          echo "HERO_TARGET_RUN_ID=${GITHUB_RUN_ID}" >> $GITHUB_ENV
      - name: Test Hero
        uses: unfor19/hero-action@master
        with:
          action: ${{ env.HERO_ACTION }}
          gh_token: ${{ secrets.GH_TOKEN }}
          src_repository: ${{ env.HERO_SRC_REPOSITORY }}
          src_workflow_name: ${{ env.HERO_SRC_WORKFLOW_NAME }}
          src_sha: ${{ env.HERO_SRC_SHA }}
          target_repository: ${{ env.HERO_SRC_REPOSITORY }}-test
          target_job_status: ${{ env.HERO_TARGET_JOB_STATUS }}
          target_run_id: ${{ env.TARGET_RUN_ID }}
